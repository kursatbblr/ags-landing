<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ñdeme | AGS √ñƒüretmenlik</title>
    <link rel="icon" type="image/png" href="./assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #06B6D4;
            --success: #10B981;
            --error: #EF4444;
            --bg-dark: #050208;
            --bg-card: rgba(255, 255, 255, 0.03);
            --text: #FFFFFF;
            --text-muted: #9CA3AF;
            --border: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }
        .bg-wrapper { position: fixed; inset: 0; z-index: -1; }
        .bg-gradient-1 { position: absolute; top: -30%; left: -20%; width: 60%; height: 80%; background: radial-gradient(circle, rgba(139, 92, 246, 0.12) 0%, transparent 60%); }
        .bg-gradient-2 { position: absolute; bottom: -20%; right: -20%; width: 50%; height: 60%; background: radial-gradient(circle, rgba(6, 182, 212, 0.08) 0%, transparent 60%); }

        nav { padding: 16px 24px; background: rgba(5, 2, 8, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 800; text-decoration: none; color: var(--text); }
        .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }

        .main-content { max-width: 500px; margin: 0 auto; padding: 60px 24px; }
        
        .page-header { text-align: center; margin-bottom: 32px; }
        .page-header h1 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .page-header p { color: var(--text-muted); font-size: 16px; }

        .state-container { text-align: center; padding: 60px 20px; }
        .state-icon { font-size: 64px; margin-bottom: 20px; }
        .state-title { font-size: 24px; font-weight: 700; margin-bottom: 12px; }
        .state-desc { color: var(--text-muted); margin-bottom: 24px; line-height: 1.6; }

        .spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .checkout-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 32px; }
        
        .user-badge { display: flex; align-items: center; gap: 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 16px; padding: 16px; margin-bottom: 24px; }
        .user-avatar { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .user-info { flex: 1; }
        .user-name { font-weight: 700; font-size: 16px; }
        .user-email { color: var(--text-muted); font-size: 14px; }
        .verified-badge { color: var(--success); font-size: 12px; display: flex; align-items: center; gap: 4px; margin-top: 4px; }

        .package-card { background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .package-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .package-name { font-size: 18px; font-weight: 700; }
        .package-badge { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .package-features { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .package-feature { background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px; font-size: 12px; color: var(--text-muted); }
        .package-price-row { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
        .package-period { color: var(--text-muted); font-size: 14px; }
        .package-price { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, var(--text), var(--primary-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .order-summary { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-bottom: 24px; }
        .order-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; color: var(--text-muted); }
        .order-row.total { border-top: 1px solid var(--border); margin-top: 8px; padding-top: 16px; font-size: 18px; font-weight: 700; color: var(--text); }
        .order-row.total span:last-child { color: var(--primary-light); }

        .btn-pay { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; border-radius: 14px; color: white; font-size: 17px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); display: flex; align-items: center; justify-content: center; gap: 10px; font-family: inherit; transition: all 0.3s; }
        .btn-pay:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(139, 92, 246, 0.5); }
        .btn-pay:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .btn-pay.whatsapp { background: linear-gradient(135deg, #25D366, #128C7E); box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4); }
        .btn-pay.whatsapp:hover { box-shadow: 0 8px 30px rgba(37, 211, 102, 0.5); }

        .secure-note { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 16px; font-size: 13px; color: var(--text-muted); }

        .timer-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); color: #FCD34D; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-bottom: 24px; }

        .btn-secondary { display: inline-flex; align-items: center; gap: 8px; padding: 14px 24px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 15px; font-weight: 600; text-decoration: none; transition: all 0.3s; }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        .divider { display: flex; align-items: center; gap: 16px; margin: 24px 0; color: var(--text-muted); font-size: 13px; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        @media (max-width: 480px) {
            .checkout-card { padding: 24px 20px; }
            .package-price { font-size: 28px; }
        }
    </style>
</head>
<body>
    <div class="bg-wrapper">
        <div class="bg-gradient-1"></div>
        <div class="bg-gradient-2"></div>
    </div>

    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">üéØ</div>
                <span>AGS</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <!-- Loading State -->
        <div id="loadingState" class="state-container">
            <div class="spinner"></div>
            <div class="state-title">Y√ºkleniyor...</div>
            <div class="state-desc">√ñdeme bilgileri alƒ±nƒ±yor</div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="state-container" style="display: none;">
            <div class="state-icon">‚ùå</div>
            <div class="state-title" id="errorTitle">Ge√ßersiz Link</div>
            <div class="state-desc" id="errorDesc">Bu √∂deme linki ge√ßersiz veya s√ºresi dolmu≈ü. L√ºtfen uygulamadan yeni bir √∂deme ba≈ülatƒ±n.</div>
            <a href="index.html" class="btn-secondary">Ana Sayfaya D√∂n</a>
        </div>

        <!-- Expired State -->
        <div id="expiredState" class="state-container" style="display: none;">
            <div class="state-icon">‚è∞</div>
            <div class="state-title">S√ºre Doldu</div>
            <div class="state-desc">Bu √∂deme oturumunun s√ºresi dolmu≈ü. G√ºvenliƒüiniz i√ßin √∂deme linkleri 30 dakika ge√ßerlidir. L√ºtfen uygulamadan yeni bir √∂deme ba≈ülatƒ±n.</div>
            <a href="index.html" class="btn-secondary">Ana Sayfaya D√∂n</a>
        </div>

        <!-- Success State -->
        <div id="successState" class="state-container" style="display: none;">
            <div class="state-icon">‚úÖ</div>
            <div class="state-title">√ñdeme Ba≈üarƒ±lƒ±!</div>
            <div class="state-desc">Paketiniz aktif edildi. Uygulamaya d√∂n√ºp √∂ƒürenmeye ba≈ülayabilirsiniz.</div>
            <a href="index.html" class="btn-secondary">Uygulamaya D√∂n</a>
        </div>

        <!-- Checkout State -->
        <div id="checkoutState" style="display: none;">
            <div class="page-header">
                <h1>√ñdemeyi Tamamla</h1>
                <p>G√ºvenli √∂deme ile paketinizi aktifle≈ütirin</p>
            </div>

            <div class="checkout-card">
                <!-- Timer -->
                <div style="text-align: center;">
                    <div class="timer-badge">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span id="timerText">29:59 kaldƒ±</span>
                    </div>
                </div>

                <!-- User Info -->
                <div class="user-badge">
                    <div class="user-avatar">üë§</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Kullanƒ±cƒ±</div>
                        <div class="user-email" id="userEmail">email@example.com</div>
                        <div class="verified-badge">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                            Doƒürulanmƒ±≈ü hesap
                        </div>
                    </div>
                </div>

                <!-- Package Info -->
                <div class="package-card">
                    <div class="package-header">
                        <div class="package-name" id="packageName">AGS Hazƒ±rlƒ±k Paketi</div>
                        <div class="package-badge">Premium</div>
                    </div>
                    <div class="package-features">
                        <span class="package-feature">‚úì 10.000+ Soru</span>
                        <span class="package-feature">‚úì AI Asistan</span>
                        <span class="package-feature">‚úì T√ºm Dersler</span>
                        <span class="package-feature">‚úì Sƒ±nƒ±rsƒ±z G√ºncelleme</span>
                    </div>
                    <div class="package-price-row">
                        <span class="package-period" id="packagePeriod">2026 KPSS'e kadar</span>
                        <span class="package-price" id="packagePrice">499‚Ç∫</span>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <div class="order-row">
                        <span>Paket √úcreti</span>
                        <span id="summaryPrice">499‚Ç∫</span>
                    </div>
                    <div class="order-row">
                        <span>ƒ∞ndirim</span>
                        <span>0‚Ç∫</span>
                    </div>
                    <div class="order-row total">
                        <span>Toplam</span>
                        <span id="totalPrice">499‚Ç∫</span>
                    </div>
                </div>

                <!-- Pay Button - WhatsApp for now -->
                <button class="btn-pay whatsapp" id="payBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    WhatsApp ile √ñdeme Yap
                </button>

                <div class="divider">veya</div>

                <button class="btn-pay" id="cardPayBtn" disabled style="opacity: 0.5;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    Kredi Kartƒ± ile √ñde (Yakƒ±nda)
                </button>

                <div class="secure-note">
                    üîí 256-bit SSL ile g√ºvenli √∂deme
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://edqocwwqlmyntkvurpef.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkcW9jd3dxbG15bnRrdnVycGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODgxNTYsImV4cCI6MjA4MDM2NDE1Nn0.6OVs_wMxAZtOkoIwYQYfKYwU4yEDz2AX4Y8JM5SU7C8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // WhatsApp numarasƒ± - KENDƒ∞ NUMARANIZI YAZIN
        const WHATSAPP_NUMBER = '905XXXXXXXXX';

        let sessionData = null;
        let timerInterval = null;

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Show state
        function showState(stateId) {
            ['loadingState', 'errorState', 'expiredState', 'successState', 'checkoutState'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(stateId).style.display = 'block';
        }

        // Show error
        function showError(title, desc) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorDesc').textContent = desc;
            showState('errorState');
        }

        // Start timer
        function startTimer(expiresAt) {
            const updateTimer = () => {
                const now = new Date();
                const expires = new Date(expiresAt);
                const diff = expires - now;

                if (diff <= 0) {
                    clearInterval(timerInterval);
                    showState('expiredState');
                    return;
                }

                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('timerText').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} kaldƒ±`;
            };

            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Initialize
        async function init() {
            if (!token) {
                showError('Ge√ßersiz Link', '√ñdeme tokeni bulunamadƒ±. L√ºtfen uygulamadan yeni bir √∂deme ba≈ülatƒ±n.');
                return;
            }

            try {
                // Fetch payment session
                const { data, error } = await supabase
                    .from('payment_sessions')
                    .select('*')
                    .eq('token', token)
                    .single();

                if (error || !data) {
                    showError('Ge√ßersiz Link', 'Bu √∂deme linki ge√ßersiz. L√ºtfen uygulamadan yeni bir √∂deme ba≈ülatƒ±n.');
                    return;
                }

                // Check if expired
                if (new Date(data.expires_at) < new Date()) {
                    showState('expiredState');
                    return;
                }

                // Check if already completed
                if (data.status === 'completed') {
                    showState('successState');
                    return;
                }

                sessionData = data;

                // Update UI
                document.getElementById('userName').textContent = data.display_name || 'Kullanƒ±cƒ±';
                document.getElementById('userEmail').textContent = data.email;
                document.getElementById('packageName').textContent = data.package_name;
                document.getElementById('packagePrice').textContent = data.package_price + '‚Ç∫';
                document.getElementById('summaryPrice').textContent = data.package_price + '‚Ç∫';
                document.getElementById('totalPrice').textContent = data.package_price + '‚Ç∫';

                // Start timer
                startTimer(data.expires_at);

                // Show checkout
                showState('checkoutState');

            } catch (err) {
                console.error('Init error:', err);
                showError('Bir Hata Olu≈ütu', 'L√ºtfen daha sonra tekrar deneyin.');
            }
        }

        // WhatsApp payment
        document.getElementById('payBtn').addEventListener('click', () => {
            if (!sessionData) return;

            const message = encodeURIComponent(
                `üéØ AGS √ñƒüretmenlik - Paket Sipari≈üi\n\n` +
                `üì¶ Paket: ${sessionData.package_name}\n` +
                `üí∞ Tutar: ${sessionData.package_price}‚Ç∫\n` +
                `üìß E-posta: ${sessionData.email}\n` +
                `üîë Sipari≈ü Kodu: ${sessionData.token.substring(0, 8).toUpperCase()}\n\n` +
                `√ñdeme bilgilerini payla≈üƒ±r mƒ±sƒ±nƒ±z?`
            );

            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, '_blank');
        });

        // Init
        init();
    </script>
</body>
</html>
